<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‚úàÔ∏è Snax Cabin Crew Allowance Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#ffffff;--text:#111;--muted:#666;--line:#e9e9e9;--red:#DA0D18;--red-dark:#A00A10}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:15px/1.5 'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{max-width:960px;margin:0 auto;padding:0 16px}
.banner{background:#fff;border-bottom:1px solid var(--line)}
.banner .wrap{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:10px;padding:14px 0}
.brand .logo{width:36px;height:36px;border-radius:10px;background:#fff;display:grid;place-items:center;color:var(--red);font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,.06);border:1px solid var(--line)}
.brand h1{font-size:18px;font-weight:700;margin:0;letter-spacing:.2px}
.content{display:grid;gap:16px;padding:16px 0}
.card{background:#fff;color:var(--text);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 2px 6px rgba(0,0,0,.03)}
.card h2{font-size:16px;font-weight:700;margin:0 0 8px}
.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.kpi{background:var(--red);color:#fff;border:1px solid var(--red-dark)}
.kpi h3{margin:0 0 6px;font-size:14px;font-weight:600;opacity:.95}
.value{font-size:28px;font-weight:700}
label.small{font-size:12px;color:#666;margin-right:6px}
.smallnote{font-size:12px;color:#555}
select{appearance:none;background:#fff url('data:image/svg+xml;utf8,<svg fill="%23666" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><polygon points="0,0 20,0 10,10"/></svg>') no-repeat right 10px center;background-size:10px;color:var(--text);border:1px solid var(--line);border-radius:12px;padding:10px 28px 10px 12px;font-weight:600}
.selector-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:10px}
.selector-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.selector-row .mini{background:#fff;color:var(--text);border:1px solid var(--line);padding:8px 10px;border-radius:12px;cursor:pointer;font-size:12px;font-weight:600}
.selector-row .mini:hover{border-color:#ccc}
.pill{display:inline-block;background:#f2f2f2;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600}
.btn{background:#fff;color:var(--text);border:1px solid var(--line);border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700}
.btn:hover{border-color:#ccc}
.btn.small{padding:8px 10px;font-size:13px}
.table-wrap{overflow:auto;border-radius:12px;border:1px solid var(--line);background:#fff}
table{width:100%;border-collapse:collapse}
thead th{background:#fafafa;color:#000;font-weight:700;border-bottom:1px solid var(--line);font-size:13px;white-space:nowrap}
th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:middle}
tbody tr:hover{background:#fcfcfc}
.footer{color:#555;border-top:1px solid var(--line);padding:12px 0;margin-top:8px;text-align:center;font-size:12px}
</style>
</head>
<body>
  <div class="banner">
    <div class="wrap">
      <div class="brand">
        <div class="logo">‚úàÔ∏è</div>
        <h1>Snax Cabin Crew Allowance Calculator</h1>
      </div>
    </div>
  </div>

  <main class="wrap content">
    <section class="card">
      <h2>Settings</h2>
      <div class="tools" style="display:flex;gap:8px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:8px;">
          <label class="small" for="rankSelect">Rank:</label>
          <select id="rankSelect">
            <option value="CC" selected>CC</option>
            <option value="PUR/SCC">PUR/SCC</option>
          </select>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Select Flights</h2>
      <div id="selectors" class="selector-grid"></div>

      <div style="display:flex;align-items:center;gap:10px;margin-top:8px;flex-wrap:wrap">
        <label class="small" for="sickSelect">Sick Leave:</label>
        <select id="sickSelect">
          <option value="none" selected>No sick leave</option>
          <option value="1">1 day sick leave</option>
          <option value="2+">2 days + sick leave</option>
        </select>
        <span id="sickInfo" class="smallnote"></span>
      </div>

      <p class="smallnote">Choose your flights. For non‚ÄëDEL flights, set a <b>Layover</b> of <b>24H</b> (default), <b>48H</b> (+2,880), or <b>72H</b> (+5,670). DEL is <b>Quickturn</b>.</p>
    </section>

    <div id="captureArea">
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <h2 style="margin:0">Selected Flights</h2>
        </div>
        <!-- Single centered action button -->
        <div class="tools" style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button id="savePng" class="btn small">Save / Share Image</button>
        </div>
        <div class="table-wrap" style="margin-top:8px;">
          <table id="listTable">
            <thead>
              <tr>
                <th>Flight</th>
                <th>Layover</th>
                <th>Block Hours</th>
                <th>Allowance (THB)</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Rank line (left-aligned, soft gray) -->
      <div id="rankDisplay" class="smallnote" style="margin:2px 0 0 2px;">Rank: CC</div>

      <section class="kpis" style="margin-top:6px;">
        <div class="card kpi">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div>
              <h3>Total Block Hours</h3>
              <div id="totalHours" class="value">0:00 H</div>
            </div>
          </div>
        </div>
        <div class="card kpi">
          <h3>Total Allowance</h3>
          <div id="totalAllowance" class="value">0 THB</div>
          <div id="deductNote" style="margin-top:4px;color:#fff;opacity:.9;font-size:12px"></div>
        </div>
      </section>
    </div>

    <div style="text-align:center;margin-top:12px;color:#555;font-size:13px;">
      üßç‚Äç‚ôÇÔ∏è Visitors:
      <img src="https://visitor-badge.laobi.icu/badge?page_id=snaxspace.cabin-crew-allowance"
           alt="visitor badge"
           style="vertical-align:middle;margin-left:4px;">
    </div>
  </main>

  <footer class="footer">
    <div class="wrap">SNAX: Just a forecast, ok?</div>
  </footer>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const FLIGHTS = [
  { code: "DEL", block: "8:35", allowance: 4290 },
  { code: "PVG", block: "8.55", allowance: 7230 },
  { code: "ICN", block: "11.45", allowance: 8230 },
  { code: "KIX", block: "12.15", allowance: 8400 },
  { code: "NGO", block: "12.30", allowance: 8490 },
  { code: "NRT", block: "13.40", allowance: 8890 },
  { code: "CTS", block: "15.00", allowance: 9370 }
];

const LAYOVER_EXTRA = { "24": 0, "48": 2880, "72": 5670 };
const RANK_BONUS   = { "CC": 0, "PUR/SCC": 500 };

let chosen = [];
let rowCounter = 0;
let sickMode = 'none';
let rankMode = 'CC';

function $(s){ return document.querySelector(s); }
function fmtTHB(n){ return new Intl.NumberFormat('en-TH', {maximumFractionDigits:0}).format(n) + ' THB'; }
function parseBlockToMinutes(s){
  if(typeof s === 'number'){ return Math.round(s*60); }
  if(!s) return 0; s=String(s).trim();
  if(s.includes(':')){ const [h,m]=s.split(':').map(v=>parseInt(v,10)||0); return h*60+m; }
  if(s.includes('.')){ const [h,mm]=s.split('.'); return (parseInt(h,10)||0)*60 + (parseInt(mm,10)||0); }
  const h=parseInt(s,10)||0; return h*60;
}
function minutesToHMM(mins){ const h=Math.floor(mins/60), m=mins%60; return h+':'+String(m).padStart(2,'0'); }
function formatBlock(s){ return minutesToHMM(parseBlockToMinutes(s)); }

// Rank-aware option label
function optionLabel(f){
  const bonus = RANK_BONUS[rankMode] || 0;
  const displayAllowance = (Number(f.allowance) || 0) + bonus;
  return `${f.code} ‚Äî ${formatBlock(f.block)} ¬∑ ${new Intl.NumberFormat('en-TH',{maximumFractionDigits:0}).format(displayAllowance)} THB`;
}

// Refresh dropdown labels to reflect current rank
function refreshFlightOptionLabels(){
  document.querySelectorAll('#selectors .selector-row select:first-child').forEach(sel => {
    const current = sel.value;
    sel.innerHTML = '<option value="">Select a flight‚Ä¶</option>' +
      FLIGHTS.map(f => `<option value="${f.code}">${optionLabel(f)}</option>`).join('');
    sel.value = current;
  });
}

function rowAllowance(entry){
  const layExtra = entry.layover === 'QT' ? 0 : (LAYOVER_EXTRA[entry.layover] || 0);
  const rankExtra = RANK_BONUS[rankMode] || 0;
  return (Number(entry.baseAllowance) || 0) + layExtra + rankExtra;
}

function init(){
  renderSelectors(10);
  renderList();
  compute();

  document.getElementById('savePng').addEventListener('click', saveAsPicture);

  const sSel = document.getElementById('sickSelect');
  sSel.addEventListener('change', () => { sickMode = sSel.value; compute(); });

  const rSel = document.getElementById('rankSelect');
  rSel.addEventListener('change', () => {
    rankMode = rSel.value;
    updateRankDisplay();
    refreshFlightOptionLabels(); // reflect rank in dropdown options
    renderList();
    compute();
  });

  // initialize from current controls
  rankMode = rSel.value;
  sickMode = sSel.value;
  updateRankDisplay();
  refreshFlightOptionLabels();
}

function updateRankDisplay(){
  const el = document.getElementById('rankDisplay');
  if(el){ el.textContent = 'Rank: ' + rankMode; }
}

function renderSelectors(n){
  const wrap = $('#selectors'); wrap.innerHTML='';
  for(let i=0;i<n;i++){ addSelectorRow(wrap); }
}

function addSelectorRow(parent){
  const rowId = ++rowCounter;
  const row = document.createElement('div');
  row.className='selector-row';

  const select = document.createElement('select');
  select.innerHTML = '<option value="">Select a flight‚Ä¶</option>' + FLIGHTS.map(f => `<option value="${f.code}">${optionLabel(f)}</option>`).join('');
  select.dataset.rowId = rowId;

  const layLabel = document.createElement('label');
  layLabel.className = 'small';
  layLabel.textContent = 'Layover:';

  const layoverSelect = document.createElement('select');
  layoverSelect.innerHTML = '<option value="24">24H</option><option value="48">48H</option><option value="72">72H</option>';
  layoverSelect.dataset.rowId = rowId;
  layoverSelect.value = '24';

  const quickturn = document.createElement('span');
  quickturn.className = 'pill';
  quickturn.textContent = 'Quickturn';
  quickturn.style.display = 'none';

  const resetBtn = document.createElement('button');
  resetBtn.className = 'mini';
  resetBtn.textContent = 'Reset';
  resetBtn.disabled = true;

  function updateEntryForRow(code){
    const data = FLIGHTS.find(f => f.code === code);
    if(!data) return;
    if (select.dataset.addedIndex !== undefined) {
      const idx = parseInt(select.dataset.addedIndex, 10);
      if (!isNaN(idx) && chosen[idx] && chosen[idx]._rowId === rowId) {
        chosen.splice(idx, 1);
      }
    }
    let lay = '24';
    if(code === 'DEL'){
      lay = 'QT';
    } else {
      lay = layoverSelect.value || '24';
    }
    const entry = {
      code: data.code,
      block: data.block,
      baseAllowance: Number(data.allowance),
      layover: lay,
      _rowId: rowId
    };
    chosen.push(entry);
    renderList(); compute();
    resetBtn.disabled = false;
    select.dataset.addedIndex = String(chosen.length-1);
  }

  select.addEventListener('change', () => {
    const code = select.value;
    if(!code) return;
    if(code === 'DEL'){
      layLabel.style.display = 'none';
      layoverSelect.style.display = 'none';
      quickturn.style.display = 'inline-block';
    } else {
      layLabel.style.display = 'inline-block';
      layoverSelect.style.display = 'inline-block';
      quickturn.style.display = 'none';
      layoverSelect.value = '24';
    }
    updateEntryForRow(code);
  });

  layoverSelect.addEventListener('change', () => {
    const code = select.value;
    if(!code || code === 'DEL') return;
    updateEntryForRow(code);
  });

  resetBtn.addEventListener('click', () => {
    const idx = parseInt(select.dataset.addedIndex || '-1',10);
    if(!isNaN(idx) && chosen[idx] && chosen[idx]._rowId === rowId){
      chosen.splice(idx,1); renderList(); compute();
    }
    select.value=''; layoverSelect.value='24';
    select.dataset.addedIndex=undefined; resetBtn.disabled=true;
    layLabel.style.display='inline-block'; layoverSelect.style.display='inline-block'; quickturn.style.display='none';
  });

  row.appendChild(select);
  row.appendChild(layLabel);
  row.appendChild(layoverSelect);
  row.appendChild(quickturn);
  row.appendChild(resetBtn);
  parent.appendChild(row);
}

function renderList(){
  const tbody = document.querySelector('#listTable tbody'); tbody.innerHTML='';
  chosen.forEach((item, idx) => {
    const layLabel = item.layover === 'QT' ? 'Quickturn' : (item.layover + ' H');
    const tr = document.createElement('tr');
    const allowance = rowAllowance(item);
    tr.innerHTML = `
      <td><span class="pill">${item.code}</span></td>
      <td>${layLabel}</td>
      <td>${formatBlock(item.block)}</td>
      <td>${fmtTHB(allowance)}</td>
      <td><button class="btn small" data-idx="${idx}">Remove</button></td>`;
    tr.querySelector('button').addEventListener('click', (e) => {
      const i = +e.currentTarget.getAttribute('data-idx');
      chosen.splice(i,1); renderList(); compute();
    });
    tbody.appendChild(tr);
  });
}

function clearAll(){ /* removed: no UI */ }
function exportCsv(){ /* removed: no UI */ }

async function saveAsPicture(){
  const target = document.getElementById('captureArea');
  try {
    const canvas = await html2canvas(target, { backgroundColor: '#ffffff', scale: 2 });
    await new Promise((resolve, reject) => {
      canvas.toBlob(async (blob) => {
        if (!blob) return reject(new Error('Canvas toBlob failed.'));
        const file = new File([blob], 'snax-allowance.png', { type: 'image/png' });

        // Prefer native share (Android Chrome, iOS 16.4+ Safari)
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          try {
            await navigator.share({ files: [file], title: 'Snax Allowance', text: 'Selected flights & totals' });
            return resolve();
          } catch (e) { /* fall back */ }
        }

        // Fallback to download / open
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'snax-allowance.png';
        const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
        if (isIOS) window.open(url, '_blank', 'noopener'); else a.click();
        URL.revokeObjectURL(url);
        resolve();
      }, 'image/png');
    });
  } catch (err) {
    console.error(err);
    alert('Could not generate image. Try again.');
  }
}

function compute(){
  let totalMinutes=0, totalAllowance=0;
  chosen.forEach(it => { totalMinutes += parseBlockToMinutes(it.block); totalAllowance += rowAllowance(it); });
  const hours = totalMinutes/60;
  let deduction = 0;
  if(sickMode==='1') deduction = Math.round(hours * 10);
  else if(sickMode==='2+') deduction = Math.round(hours * 100);
  const finalAllowance = Math.max(0, totalAllowance - deduction);
  document.getElementById('totalHours').textContent = minutesToHMM(totalMinutes) + ' H';
  document.getElementById('totalAllowance').textContent = new Intl.NumberFormat('en-TH',{maximumFractionDigits:0}).format(finalAllowance) + ' THB';
  const sickMap = { 'none':'No sick leave', '1':'1 day sick leave', '2+':'2 days + sick leave' };
  document.getElementById('sickInfo').textContent = sickMap[sickMode] + (deduction>0 ? ` ‚Äî deduction: -${new Intl.NumberFormat('en-TH',{maximumFractionDigits:0}).format(deduction)} THB` : '');
  document.getElementById('deductNote').textContent = deduction>0 ? `Includes sick-leave deduction of -${new Intl.NumberFormat('en-TH',{maximumFractionDigits:0}).format(deduction)} THB` : '';
}

document.addEventListener('DOMContentLoaded', ()=>{
  // No persistence: page refresh resets everything by design.
  init();
});
</script>
</body>
</html>
