<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‚úàÔ∏è Snax Cabin Crew Allowance Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<!-- üß≠ SNAX App Icon & Manifest -->
<link rel="apple-touch-icon" sizes="180x180" href="https://snaxspace.github.io/cabin-crew-allowance/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="167x167" href="https://snaxspace.github.io/cabin-crew-allowance/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="152x152" href="https://snaxspace.github.io/cabin-crew-allowance/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="120x120" href="https://snaxspace.github.io/cabin-crew-allowance/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://snaxspace.github.io/cabin-crew-allowance/icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="https://snaxspace.github.io/cabin-crew-allowance/icons/icon-512.png">
<link rel="manifest" href="https://snaxspace.github.io/cabin-crew-allowance/manifest.json">
<meta name="theme-color" content="#DA0D18">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Crew Allowance">

<style>
/* ---------- THEME TOKENS ---------- */
:root{
  --bg:#ffffff;
  --card:#ffffff;
  --text:#101114;
  --muted:#6b7280;
  --line:#e5e7eb;
  --red:#DA0D18;
  --red-dark:#A00A10;
  --pill:#f2f2f2;
  --btn:#ffffff;
  --btn-text:#101114;
  --shadow:0 2px 8px rgba(0,0,0,.05);
}
:root[data-theme="dark"]{
  --bg:#0b0c10;
  --card:#121317;
  --text:#eef0f3;
  --muted:#9aa3af;
  --line:#22252b;
  --red:#DA0D18;
  --red-dark:#8b070c;
  --pill:#1a1c22;
  --btn:#1a1c22;
  --btn-text:#eef0f3;
  --shadow:0 2px 10px rgba(0,0,0,.25);
}

*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:15px/1.5 'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial}

/* ---------- LAYOUT ---------- */
.wrap{max-width:960px;margin:0 auto;padding:0 16px}
.banner{background:var(--card);border-bottom:1px solid var(--line)}
.banner .wrap{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:10px;padding:14px 0}
.brand .logo{width:36px;height:36px;border-radius:10px;background:#fff;display:grid;place-items:center;color:var(--red);font-weight:700;box-shadow:var(--shadow);border:1px solid var(--line)}
.brand h1{font-size:18px;font-weight:700;margin:0;letter-spacing:.2px}
.content{display:grid;gap:16px;padding:16px 0}
.card{background:var(--card);color:var(--text);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
.card h2{font-size:16px;font-weight:700;margin:0 0 8px}
.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.kpi{background:var(--red);color:#fff;border:1px solid var(--red-dark);border-radius:14px}
.kpi h3{margin:0 0 6px;font-size:14px;font-weight:600;opacity:.95;padding:14px 14px 0}
.value{font-size:28px;font-weight:700;padding:0 14px 14px}
label.small{font-size:12px;color:var(--muted);margin-right:6px}
.smallnote{font-size:12px;color:var(--muted)}
select{
  appearance:none;
  background:var(--card) url('data:image/svg+xml;utf8,<svg fill="%239AA3AF" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><polygon points="0,0 20,0 10,10"/></svg>') no-repeat right 10px center;
  background-size:10px;
  color:var(--text);
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px 28px 10px 12px;
  font-weight:600;
  min-width:200px;
}

/* Center value in flight selects */
select.flight-select{ text-align:center; text-align-last:center; }
select.flight-select option{ text-align:center; }

/* HERO: Flight selector emphasis */
.selector-row select.flight-select{
  border:2px solid var(--red);
  font-weight:700;
  box-shadow:0 1px 5px rgba(218,13,24,0.2);
  background:var(--card);
  color:var(--text);
}

/* One-line compact selector rows */
.selector-row{
  display:flex; align-items:center; gap:6px; width:100%;
  flex-wrap:nowrap; overflow-x:hidden;
  padding:4px 0;
}
.selector-row .flight-select{ flex:1 1 50%; min-width:120px; }
.selector-row .layover-select{
  flex:0 0 auto;
  padding:6px 18px 6px 8px;
  font-size:13px;
  min-width:78px;
  border:1px solid var(--line);
  font-weight:600;
}
.selector-row .lay-label.small{font-size:12px;color:var(--muted)}
.pill{display:inline-block;background:var(--pill);padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;white-space:nowrap}

/* OP/DH chips (subtle) + info icon */
.ops-toggle{ display:flex; align-items:center; gap:6px; margin-left:2px; flex:0 0 auto; }
.chip{
  border:1px solid var(--line);
  border-radius:999px;
  padding:3px 6px;
  font-size:11px; font-weight:700;
  background:var(--pill);
  cursor:pointer; user-select:none;
  white-space:nowrap;
  color:var(--text);
}
.chip.active{
  border-color:var(--line);
  background:var(--pill);
  color:var(--text);
}
.info-icon{
  width:18px;height:18px;border-radius:50%;
  border:1px solid var(--line);
  display:grid;place-items:center;
  font-size:12px;font-weight:700;color:var(--muted);
  background:var(--pill); cursor:pointer;
  flex:0 0 auto;
}

/* Delete ‚Äú√ó‚Äù button */
.selector-row .spacer{flex:1 0 auto}
.selector-row .del{
  background:transparent;
  border:1px solid var(--line);
  color:var(--muted);
  width:28px;height:28px;border-radius:8px;
  display:grid;place-items:center;
  cursor:pointer;font-weight:700;line-height:1;
  margin-left:auto; flex:0 0 auto;
}
.selector-row .del:hover{border-color:#cfcfcf;color:#666}

/* Buttons */
.btn{background:var(--btn);color:var(--btn-text);border:1px solid var(--line);border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700;min-width:160px}
.btn:hover{border-color:#ccc}
.btn.small{padding:10px 12px;font-size:14px}
.btn.ghost{background:transparent;border:1px dashed var(--line);}

/* ---------- SUMMARY LIST ---------- */
.summary-wrap{margin-top:8px}
.summary-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.summary-item{
  display:flex;align-items:center;justify-content:space-between;
  gap:8px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:var(--card);
  box-shadow:var(--shadow);font-weight:600;
}
.summary-item .left{display:flex;align-items:center;gap:8px;min-width:0}
.summary-item .code{background:var(--pill);border-radius:999px;padding:4px 10px;font-weight:700}
.summary-item .count{color:var(--muted);font-weight:600}
.summary-item .amount{white-space:nowrap}

/* Stack of selector rows */
.selector-grid { display:flex; flex-direction:column; gap:10px; }

/* --------- Responsive (‚â§820px) --------- */
@media (max-width:820px){
  .brand h1{font-size:16px}
  .kpis{grid-template-columns:1fr}
  select{min-width:0}
  .btn{width:100%}
  .value{font-size:26px}
  .summary-grid{grid-template-columns:1fr}

  .selector-row{ gap:4px; }
  .selector-row .flight-select{
    flex:1 1 38%;
    min-width:0;
    max-width:44vw;
    padding:8px 20px 8px 10px;
  }

  .selector-row .lay-label{ display:none !important; }

  .selector-row .layover-select{
    min-width:60px;
    padding:4px 10px 4px 8px;
    font-size:10.5px;
  }

  .ops-toggle{ gap:3px; }
  .ops-toggle .chip{ padding:1px 5px; font-size:9.5px; }
  .ops-toggle .info-icon{ display:none; }

  .selector-row .del{ width:24px; height:24px; }
}

/* ---------- DARK MODE TOGGLE ---------- */
.switch{position:relative;display:inline-block;width:54px;height:30px;vertical-align:middle}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;border:1px solid #c7ccd3;transition:.2s;border-radius:999px}
.slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;top:3px;background:white;transition:.2s;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.25)}
input:checked + .slider{background:#111827;border-color:#0b0c10}
.slider:before{will-change:transform}
input:checked + .slider:before{transform:translateX(24px)}
.footer{color:var(--muted);border-top:1px solid var(--line);padding:12px 0;margin-top:8px;text-align:center;font-size:12px}

/* ---------- Install hint & help ---------- */
.install-hint{
  display:none;
  border:1px dashed var(--line);
  border-radius:12px;
  padding:10px 12px;
  background:var(--card);
  font-size:13px;
  margin-top:10px;
}
.install-hint strong{font-weight:700;}
.install-hint button{
  border:none;
  background:transparent;
  color:var(--muted);
  font-size:12px;
  font-weight:600;
  cursor:pointer;
  margin-left:auto;
}
.help-link{
  margin-top:8px;
  font-size:12px;
  color:var(--red);
  background:none;
  border:none;
  padding:0;
  cursor:pointer;
  text-decoration:underline;
}
</style>
</head>
<body>
  <div class="banner">
    <div class="wrap">
      <div class="brand">
        <div class="logo">‚úàÔ∏è</div>
        <h1>Snax Cabin Crew Allowance Calculator</h1>
      </div>
    </div>
  </div>

  <main class="wrap content">
    <section class="card">
      <h2>Settings</h2>
      <div class="tools" style="display:flex;gap:14px;flex-wrap:wrap;align-items:center">
        <div style="display:flex;align-items:center;gap:8px;">
          <label class="small" for="rankSelect">Rank:</label>
          <select id="rankSelect">
            <option value="CC" selected>CC</option>
            <option value="PUR/SCC">PUR/SCC</option>
          </select>
        </div>

        <!-- Dark Mode Toggle -->
        <div style="display:flex;align-items:center;gap:10px;">
          <label class="small" for="darkToggle">Dark mode:</label>
          <label class="switch" title="Toggle dark mode">
            <input type="checkbox" id="darkToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <!-- Permanent help link under rank -->
      <button id="installHelpToggle" class="help-link" type="button">
        How to add this app to your Home Screen?
      </button>
      <div id="installHelpText" class="smallnote" style="display:none;margin-top:4px;">
        On iPhone, open this page in Safari ‚Üí Share ‚Üí ‚ÄúAdd to Home Screen‚Äù ‚Üí Click the icon on your home screen and use it once, After that it will work ofline too!
      </div>

      <!-- Dismissible first-time hint (iOS Safari only) -->
      <div id="installHint" class="install-hint">
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <div style="font-size:18px;line-height:1.1;">üì≤</div>
          <div style="flex:1;">
            <strong>First time here?</strong><br>
            Add Crew Allowance to your Home Screen from Safari so it lives on your phone like a normal app.
          </div>
          <button type="button" id="installHintClose">Got it</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <h2 style="margin:0;">Select Flights</h2>
        <button id="resetFlights" class="btn small" type="button" style="min-width:auto;padding:6px 10px;font-size:12px;">
          Reset
        </button>
      </div>

      <div id="selectors" class="selector-grid"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px">
        <button id="addFlightBtn" class="btn ghost small" style="min-width:auto;">+ Add flight</button>
      </div>

      <div style="display:flex;align-items:center;gap:10px;margin-top:8px;flex-wrap:wrap">
        <label class="small" for="sickSelect">Sick Leave:</label>
        <select id="sickSelect">
          <option value="none" selected>No sick leave</option>
          <option value="1">1 day sick leave</option>
          <option value="2+">2 days + sick leave</option>
        </select>
      </div>

      <p class="smallnote" style="margin-top:8px">
        Use OP/DH to mark deadhead if needed.<br>
        OP = Operating, DH = Deadhead
      </p>
    </section>

    <div id="captureArea">
      <section class="card" style="padding:12px;">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
    <div style="font-weight:700;">Base Salary</div>
    <div style="display:flex;align-items:center;gap:8px;">
      <span class="smallnote">THB</span>
      <input id="baseSalaryInput" inputmode="numeric" type="number" min="0" step="100"
        placeholder="0"
        style="width:160px;max-width:60vw;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--text);font-weight:700;text-align:right;">
    </div>
  </div>
</section>
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
          <h2 style="margin:0">Per-destination Summary</h2>
        </div>
        <div class="tools center-mobile" style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button id="savePng" class="btn small">Save / Share Image</button>
        </div>
        <div id="summaryWrap" class="summary-wrap">
          <div id="summaryList" class="summary-grid"></div>
        </div>
      </section>

<div id="rankDisplay" class="smallnote" style="margin:2px 0 0 2px;">Rank: CC</div>

      <section class="kpis" style="margin-top:6px;">
        <div class="card kpi">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div>
              <h3>Total Block Hours</h3>
              <div id="totalHours" class="value">0:00 H</div>
            </div>
          </div>
        </div>
        <div class="card kpi">
<h3>Total Income</h3>
<div id="totalAllowance" class="value">0 THB</div>
          <div id="deductNote" style="margin-top:4px;color:#fff;opacity:.9;font-size:12px"></div>
        </div>
      </section>
    </div>

    <div style="text-align:center;margin-top:12px;color:var(--muted);font-size:13px;">
      üßç‚Äç‚ôÇÔ∏è Visitors:
      <img src="https://visitor-badge.laobi.icu/badge?page_id=snaxspace.cabin-crew-allowance"
           alt="visitor badge"
           style="vertical-align:middle;margin-left:4px;">
    </div>
  </main>

  <footer class="footer">
    <div class="wrap">SNAX: Just a forecast, ok?</div>
  </footer>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
/* ---------- DATA (sector minutes; DEL is quickturn) ---------- */
const FLIGHTS = [
  { code: "DEL", sectors: [270, 245], qt: true },  // 4:30, 4:05
  { code: "PVG", sectors: [255, 280], qt: false }, // 4:15, 4:40
  { code: "ICN", sectors: [335, 370], qt: false }, // 5:35, 6:10
  { code: "KIX", sectors: [345, 390], qt: false }, // 5:45, 6:30
  { code: "HRB", sectors: [350, 390], qt: false }, // 5:50, 6:30
  { code: "NGO", sectors: [345, 405], qt: false }, // 5:45, 6:45
  { code: "NRT", sectors: [370, 450], qt: false }, // 6:10, 7:30
  { code: "CTS", sectors: [410, 490], qt: false }, // 6:50, 8:10
  { code: "SDJ", sectors: [375, 450], qt: false }, // 6:15, 7:30
  { code: "ALA", sectors: [430, 400], qt: false }, // 7:10, 6:40
  { code: "RUH", sectors: [500, 430], qt: false }  // 8:20, 7:10
];

const LAYOVER_DED_HOURS = 0.25; // 15 minutes

// Base hours by label (before special handling)
const LAYOVER_BASE_HOURS = {
  "24": 24,
  "44": 44,
  "48": 48,
  "51": 51,
  "72": 72
};

const BI_RATE = { 'none': 100, '1': 90, '2+': 0 };

/* ---------- STATE ---------- */
let chosen = [];           // {code, sectors[min,min], layover:'24'|'48'|'72'|'44'|'51'|'QT', sectorOps:[bool,bool], _rowId}
let rowCounter = 0;
let sickMode = 'none';
let rankMode = 'CC';

/* ---------- UTILS ---------- */
function $(s){ return document.querySelector(s); }
function fmtTHB(n){ return new Intl.NumberFormat('en-TH', {maximumFractionDigits:0}).format(Math.round(n)) + ' THB'; }
function minutesToHMM(mins){ const h=Math.floor(mins/60), m=mins%60; return h+':'+String(m).padStart(2,'0'); }
function totalBlockMinutes(sectors){ return (sectors?.[0]||0) + (sectors?.[1]||0); }
function sortedFlights(){ return [...FLIGHTS].sort((a,b)=> totalBlockMinutes(a.sectors) - totalBlockMinutes(b.sectors) ); }
function optionLabel(f){ return f.code; }

/* ---------- PAY FORMULA ---------- */
function layoverBaht(code, layoverKey){
  // Quickturn ‚Üí no layover allowance
  if (layoverKey === 'QT') return 0;
  if (code === 'DEL') return 0;

  let hours;

  // Special fixed billed hours for KIX 44H and 51H
  if (layoverKey === '44') {
    hours = 44.25;   // 44h 15m
  } else if (layoverKey === '51') {
    hours = 51.5;    // 51h 30m
  } else {
    // Standard rule: base hours minus 15 minutes
    const base = LAYOVER_BASE_HOURS[layoverKey] ?? 24;
    hours = Math.max(0, base - LAYOVER_DED_HOURS);
  }

  return hours * 120;
}

function rowAllowance(entry){
  const isPur = (rankMode === 'PUR/SCC');

  const sectorMins = entry.sectors || [0,0];
  const totalMins = totalBlockMinutes(sectorMins);

  const ops = entry.sectorOps || [true, true];
  const operatingMins = (ops[0] ? sectorMins[0] : 0) + (ops[1] ? sectorMins[1] : 0);

  const basePay = (totalMins/60) * 250;

  const bonusRate = BI_RATE[sickMode] ?? 100;
  const bonus   = (operatingMins/60) * bonusRate;

  const perSector = isPur ? 500 : 300;
  const sectorAllowance = (ops[0] ? perSector : 0) + (ops[1] ? perSector : 0);

  const transport = 2 * (isPur ? 400 : 350);

  const lay = layoverBaht(entry.code, entry.layover);

  return basePay + bonus + sectorAllowance + transport + lay;
}

/* ---------- SUMMARY ---------- */
function renderSummary(){
  const wrap = document.getElementById('summaryList');
  wrap.innerHTML = '';
  if(!chosen.length){
    wrap.innerHTML = '<div class="smallnote" style="text-align:center">No flights selected yet.</div>';
    return;
  }
  const groups = {};
  chosen.forEach(it => {
    const key = it.code;
    if(!groups[key]) groups[key] = { code: key, count: 0, subtotal: 0 };
    groups[key].count += 1;
    groups[key].subtotal += rowAllowance(it);
  });
  Object.values(groups).sort((a,b)=>a.code.localeCompare(b.code)).forEach(g => {
    const div = document.createElement('div');
    div.className = 'summary-item';
    div.innerHTML = `
      <div class="left">
        <span class="code">${g.code}</span>
        <span class="count">√ó ${g.count}</span>
      </div>
      <div class="amount">${fmtTHB(g.subtotal)}</div>
    `;
    wrap.appendChild(div);
  });
}

/* ---------- TOTALS ---------- */
function compute(){
  let totalMinutes=0, totalAllowance=0;
  chosen.forEach(it => {
    totalMinutes += totalBlockMinutes(it.sectors);
    totalAllowance += rowAllowance(it);
  });

  document.getElementById('totalHours').textContent = minutesToHMM(totalMinutes) + ' H';
  document.getElementById('totalAllowance').textContent =
    new Intl.NumberFormat('en-TH',{maximumFractionDigits:0}).format(Math.round(totalAllowance)) + ' THB';

  document.getElementById('deductNote').textContent = '';
  renderSummary();
}

/* ---------- ROW MGMT ---------- */
function removeEntryByRow(rowId){
  const before = chosen.length;
  chosen = chosen.filter(x => x._rowId !== rowId);
  if (chosen.length !== before) compute();
}

function upsertEntry(rowId, code, lay){
  const f = FLIGHTS.find(x => x.code === code);
  if(!f) return;
  removeEntryByRow(rowId);
  chosen.push({
    code: f.code,
    sectors: [...f.sectors],
    layover: lay,
    sectorOps: [true,true],
    _rowId: rowId
  });
  compute();
}

/* ---------- SELECTORS ---------- */
function addSelectorRow(parent){
  const rowId = ++rowCounter;
  const row = document.createElement('div');
  row.className='selector-row';
  row.dataset.rowId = rowId;

  const select = document.createElement('select');
  select.className = 'flight-select';
  select.innerHTML = '<option value="">Select a flight‚Ä¶</option>' +
    sortedFlights().map(f => `<option value="${f.code}">${optionLabel(f)}</option>`).join('');

  const layLabel = document.createElement('label');
  layLabel.className = 'lay-label small';
  layLabel.textContent = 'Layover:';
  layLabel.style.display = 'none';

  const layoverSelect = document.createElement('select');
  layoverSelect.className = 'layover-select';
  layoverSelect.style.display = 'none';

  const quickturn = document.createElement('span');
  quickturn.className = 'pill';
  quickturn.textContent = 'Quickturn';
  quickturn.style.display = 'none';

  const opsWrap = document.createElement('div');
  opsWrap.className = 'ops-toggle';
  opsWrap.style.display = 'none';
  const CHIP_TIP = 'OP = Operating ¬∑ DH = Deadhead (no BI)';

  function makeChip(label, idx){
    const chip = document.createElement('span');
    chip.className = 'chip active';
    chip.dataset.idx = String(idx);
    chip.textContent = `${label}: OP`;
    chip.title = CHIP_TIP;
    chip.setAttribute('aria-label', CHIP_TIP);
    chip.addEventListener('click', () => {
      const i = Number(chip.dataset.idx);
      const nowActive = chip.classList.toggle('active');
      chip.textContent = `${label}: ${nowActive ? 'OP' : 'DH'}`;
      const entry = chosen.find(x => x._rowId === rowId);
      if (entry){
        entry.sectorOps = entry.sectorOps || [true,true];
        entry.sectorOps[i] = nowActive;
        compute();
      }
    });
    return chip;
  }
  const chip1 = makeChip('Out', 0);
  const chip2 = makeChip('In', 1);
  opsWrap.appendChild(chip1);
  opsWrap.appendChild(chip2);

  const info = document.createElement('div');
  info.className = 'info-icon';
  info.title = CHIP_TIP;
  info.setAttribute('aria-label', CHIP_TIP);
  info.textContent = 'i';
  info.addEventListener('click', () => alert(CHIP_TIP));
  opsWrap.appendChild(info);

  const spacer = document.createElement('div');
  spacer.className = 'spacer';

  const delBtn = document.createElement('button');
  delBtn.className = 'del';
  delBtn.title = 'Remove this row';
  delBtn.textContent = '√ó';

  function resetChipsToOP(){
    const LABELS = ['Out','In'];
    [chip1, chip2].forEach((chip, i) => {
      chip.classList.add('active');
      chip.textContent = `${LABELS[i]}: OP`;
      chip.title = CHIP_TIP;
      chip.setAttribute('aria-label', CHIP_TIP);
    });
  }

  function updateOpsVisibility(code){
    opsWrap.style.display = code ? 'flex' : 'none';
  }

  function buildLayoverOptionsForFlight(code) {
    let opts;
    if (code === 'KIX') {
      opts = [
        { value: '24', label: '24H' },
        { value: '44', label: '44H' },
        { value: '48', label: '48H' },
        { value: '51', label: '51H' },
        { value: '72', label: '72H' },
        { value: 'QT', label: 'Quickturn' }
      ];
    } else {
      opts = [
        { value: '24', label: '24H' },
        { value: '48', label: '48H' },
        { value: '72', label: '72H' },
        { value: 'QT', label: 'Quickturn' }
      ];
    }

    layoverSelect.innerHTML = opts
      .map(o => `<option value="${o.value}">${o.label}</option>`)
      .join('');
    layoverSelect.value = '24';
  }

  select.addEventListener('change', () => {
    const code = select.value;
    if(!code){
      layLabel.style.display='none';
      layoverSelect.style.display='none';
      quickturn.style.display='none';
      updateOpsVisibility(null);
      removeEntryByRow(rowId);
      return;
    }
    const f = FLIGHTS.find(x => x.code === code);
    if(!f) return;

    resetChipsToOP();

    if(f.qt){ // DEL quickturn
      layLabel.style.display='none';
      layoverSelect.style.display='none';
      quickturn.style.display='inline-block';
      updateOpsVisibility(code);
      upsertEntry(rowId, code, 'QT');
    } else {
      buildLayoverOptionsForFlight(code);
      quickturn.style.display='none';
      layLabel.style.display='inline-block';
      layoverSelect.style.display='inline-block';
      updateOpsVisibility(code);
      upsertEntry(rowId, code, layoverSelect.value || '24');
    }
  });

  layoverSelect.addEventListener('change', () => {
    const code = select.value;
    if(!code) return;
    const f = FLIGHTS.find(x => x.code === code);
    if(!f || f.qt) return;

    const val = layoverSelect.value || '24';

    if (val === 'QT'){
      layLabel.style.display='none';
      quickturn.style.display='none';
    } else {
      quickturn.style.display='none';
      layLabel.style.display='inline-block';
    }
    upsertEntry(rowId, code, val);
  });

  delBtn.addEventListener('click', () => {
    removeEntryByRow(rowId);
    row.remove();
  });

  row.appendChild(select);
  row.appendChild(layLabel);
  row.appendChild(layoverSelect);
  row.appendChild(quickturn);
  row.appendChild(opsWrap);
  row.appendChild(spacer);
  row.appendChild(delBtn);
  parent.appendChild(row);
}

/* ---------- SAVE / SHARE ---------- */
async function saveAsPicture(){
  const target = document.getElementById('captureArea');
  try {
    const canvas = await html2canvas(target, { backgroundColor: '#ffffff', scale: 2 });
    await new Promise((resolve, reject) => {
      canvas.toBlob(async (blob) => {
        if (!blob) return reject(new Error('Canvas toBlob failed.'));
        const file = new File([blob], 'snax-allowance.png', { type: 'image/png' });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          try {
            await navigator.share({ files: [file], title: 'Snax Allowance', text: 'Selected flights & totals' });
            return resolve();
          } catch (e) {}
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'snax-allowance.png';
        const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
        if (isIOS) window.open(url, '_blank', 'noopener'); else a.click();
        URL.revokeObjectURL(url);
        resolve();
      }, 'image/png');
    });
  } catch (err) {
    console.error(err);
    alert('Could not generate image. Try again.');
  }
}

/* ---------- INSTALL HINT & HELP ---------- */
function showInstallHintIfNeeded(){
  const hint = document.getElementById('installHint');
  const closeBtn = document.getElementById('installHintClose');
  if (!hint) return;

  if (localStorage.getItem('snax_install_hint_dismissed') === '1') {
    hint.style.display = 'none';
    return;
  }

  const ua = window.navigator.userAgent || '';
  const isIOS = /iPhone|iPad|iPod/.test(ua);
  const isStandalone = window.navigator.standalone === true;

  if (isIOS && !isStandalone) {
    hint.style.display = 'block';
  } else {
    hint.style.display = 'none';
  }

  if (closeBtn){
    closeBtn.addEventListener('click', () => {
      hint.style.display = 'none';
      localStorage.setItem('snax_install_hint_dismissed', '1');
    });
  }
}

/* ---------- RESET ---------- */
function resetAllFlights(){
  chosen = [];
  rowCounter = 0;

  renderSelectors(1);

  const sSel = document.getElementById('sickSelect');
  if (sSel){
    sSel.value = 'none';
    sickMode = 'none';
  }

  compute();
}

/* ---------- INIT ---------- */
function updateRankDisplay(){
  const el = document.getElementById('rankDisplay');
  if(el){ el.textContent = 'Rank: ' + rankMode + ' ‚Äî (Base salary not included)'; }
}

function refreshFlightOptionLabels(){
  document.querySelectorAll('#selectors .selector-row select.flight-select').forEach(sel => {
    const current = sel.value;
    sel.innerHTML = '<option value="">Select a flight‚Ä¶</option>' +
      sortedFlights().map(f => `<option value="${f.code}">${optionLabel(f)}</option>`).join('');
    sel.value = current;
  });
}

function renderSelectors(startCount){
  const wrap = document.getElementById('selectors'); 
  wrap.innerHTML='';
  for(let i=0;i<startCount;i++){ addSelectorRow(wrap); }
}

function init(){
  renderSelectors(1);
  renderSummary();
  compute();

  document.getElementById('savePng').addEventListener('click', saveAsPicture);

  const sSel = document.getElementById('sickSelect');
  sSel.addEventListener('change', () => { sickMode = sSel.value; compute(); });

  const rSel = document.getElementById('rankSelect');
  rSel.addEventListener('change', () => {
    rankMode = rSel.value;
    updateRankDisplay();
    refreshFlightOptionLabels();
    compute();
  });

  document.getElementById('addFlightBtn').addEventListener('click', () => {
    addSelectorRow(document.getElementById('selectors'));
  });

  const resetBtn = document.getElementById('resetFlights');
  if (resetBtn){
    resetBtn.addEventListener('click', resetAllFlights);
  }

  const darkToggle = document.getElementById('darkToggle');
  darkToggle.addEventListener('change', () => {
    document.documentElement.setAttribute('data-theme', darkToggle.checked ? 'dark' : 'light');
  });

  const helpToggle = document.getElementById('installHelpToggle');
  const helpText = document.getElementById('installHelpText');
  if (helpToggle && helpText){
    helpToggle.addEventListener('click', () => {
      const visible = helpText.style.display === 'block';
      helpText.style.display = visible ? 'none' : 'block';
    });
  }

  rankMode = rSel.value;
  sickMode = sSel.value;
  updateRankDisplay();
  refreshFlightOptionLabels();
  showInstallHintIfNeeded();
}

document.addEventListener('DOMContentLoaded', init);
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker
      .register('./service-worker.js')
      .catch(err => console.log('Service worker registration failed:', err));
  });
}
</script>
</body>
</html>
